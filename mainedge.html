<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简社交</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        body { background-color: #f5f7fa; color: #333; padding-bottom: 115px; }
        .header { background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding: 0 20px; }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: center; height: 60px; }
        .logo { font-size: 22px; font-weight: bold; color: #2d8cf0; text-decoration: none; }
        .publish-btn { position: absolute; right: 20px; background-color: #2d8cf0; color: white; border: none; padding: 6px 16px; border-radius: 18px; font-size: 14px; font-weight: 500; }
        .user-info { position: absolute; left: 20px; display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .user-name { font-size: 14px; font-weight: 500; color: #333; }
        /* 新增退出登录按钮样式 */
        .logout-btn {
            background-color: transparent;
            color: #666;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: color 0.2s;
        }
        .logout-btn:hover {
            color: #f53f3f; /* hover时变红提示 */
        }
        .main { max-width: 1200px; margin: 80px auto 0; display: flex; gap: 20px; }
        .content { flex: 1; }
        .sidebar { width: 280px; flex-shrink: 0; }
        .post-card { background-color: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; padding: 15px; }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .post-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .post-author { flex: 1; }
        .author-name { font-weight: 600; font-size: 15px; color: #333; }
        .post-content { font-size: 14px; line-height: 1.6; margin-bottom: 15px; color: #333; }
        .post-actions { display: flex; justify-content: flex-start; gap: 20px; padding-top: 10px; border-top: 1px solid #f5f5f5; }
        .action-btn { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666; padding: 5px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .action-btn.liked { color: #f53f3f; }
        .action-btn:hover { background-color: #f5f5f5; }
        .sidebar-card { background-color: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
        .sidebar-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px; }
        .nav-list { list-style: none; }
        .nav-item { margin-bottom: 12px; }
        .nav-link { display: flex; align-items: center; gap: 12px; text-decoration: none; color: #666; font-size: 14px; padding: 8px 10px; border-radius: 8px; }
        .nav-link.active { color: #2d8cf0; background-color: #f0f7ff; }
        .nav-icon { font-size: 18px; }
        .mobile-nav { display: none; position: fixed; bottom: 50px; left: 0; right: 0; background-color: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); height: 55px; }
        .mobile-nav-list { display: flex; justify-content: space-around; align-items: center; height: 100%; list-style: none; }
        .mobile-nav-link { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; text-decoration: none; font-size: 11px; gap: 4px; }
        .mobile-nav-link.active { color: #2d8cf0; }
        .mobile-nav-icon { font-size: 20px; }
        .pagination { position: fixed; bottom: 0; left: 0; right: 0; background-color: #fff; padding: 10px 0; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 -1px 5px rgba(0,0,0,0.05); }
        .page-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #eee; background-color: #fff; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .page-btn.active { background-color: #2d8cf0; color: white; border-color: #2d8cf0; }
        .page-btn:hover:not(.active) { border-color: #2d8cf0; color: #2d8cf0; }
        .page-prev, .page-next { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #eee; background-color: #fff; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .page-prev:hover, .page-next:hover { border-color: #2d8cf0; color: #2d8cf0; }
        .publish-container { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #fff; z-index: 200; padding: 20px; }
        .publish-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 60px; }
        .back-btn, .send-btn { padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; border: none; }
        .back-btn { background-color: #f5f5f5; color: #333; }
        .send-btn { background-color: #2d8cf0; color: white; }
        .publish-input { width: 100%; height: calc(100% - 100px); border: none; outline: none; resize: none; font-size: 16px; line-height: 1.6; }
        .loading { text-align: center; padding: 40px 0; color: #666; font-size: 14px; }
        .comments-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; border-top: 1px solid #f5f5f5; margin-top: 10px; }
        .comments-container.expanded { max-height: 500px; padding-top: 15px; }
        .comment-item { display: flex; gap: 12px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f5f5f5; }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; cursor: pointer; flex-shrink: 0; }
        .comment-content { flex: 1; }
        .comment-author { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
        .comment-text { font-size: 14px; color: #333; line-height: 1.5; }
        .comment-pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px 0; }
        .comment-input-container { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #f5f5f5; }
        .comment-input { flex: 1; padding: 8px 12px; border: 1px solid #eee; border-radius: 20px; outline: none; font-size: 14px; }
        .comment-send { padding: 8px 16px; background-color: #2d8cf0; color: white; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; }
        .profile-container { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #fff; z-index: 300; padding: 20px; overflow-y: auto; }
        .profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; height: 60px; }
        .profile-content { max-width: 800px; margin: 0 auto; }
        .profile-avatar-container { text-align: center; margin-bottom: 20px; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #f0f7ff; cursor: pointer; }
        .profile-name { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 10px; }
        .profile-personality { text-align: center; color: #666; margin-bottom: 30px; padding: 0 20px; word-break: break-all; }
        .profile-stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 22px; font-weight: 600; color: #2d8cf0; }
        .stat-label { font-size: 14px; color: #666; }
        .profile-actions { text-align: center; margin-bottom: 40px; }
        .follow-btn { padding: 8px 24px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .follow-btn.following { background-color: #f5f5f5; color: #333; border: 1px solid #eee; }
        .follow-btn.not-following { background-color: #2d8cf0; color: white; border: none; }
        .edit-btn { padding: 8px 24px; background-color: #f5f5f5; color: #333; border: 1px solid #eee; border-radius: 20px; font-size: 14px; cursor: pointer; margin-right: 10px; }
        .profile-edit-inputs { display: none; max-width: 500px; margin: 0 auto 30px; gap: 15px; flex-direction: column; }
        .profile-edit-inputs.active { display: flex; }
        .edit-input-item { width: 100%; }
        .edit-input-label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        .edit-input { width: 100%; padding: 10px 15px; border: 1px solid #eee; border-radius: 8px; outline: none; font-size: 15px; }
        .edit-textarea { width: 100%; padding: 10px 15px; border: 1px solid #eee; border-radius: 8px; outline: none; font-size: 15px; min-height: 100px; resize: vertical; }
        .save-btn { padding: 8px 24px; background-color: #2d8cf0; color: white; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; margin-right: 10px; }
        .cancel-btn { padding: 8px 24px; background-color: #f5f5f5; color: #333; border: 1px solid #eee; border-radius: 20px; font-size: 14px; cursor: pointer; }
        .hidden { display: none; }
        @media (max-width: 768px) { 
            .sidebar { display: none; } 
            .mobile-nav { display: block; } 
            .user-name { display: none; } 
            /* 移动端退出按钮样式调整 */
            .logout-btn { font-size: 12px; }
        }
        @media (max-width: 480px) { 
            .header-container { padding: 0 15px; } 
            .profile-stats { gap: 20px; } 
        }
    </style>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="user-info">
                <img src="" alt="用户头像" class="user-avatar" id="headerAvatar" data-username="">
                <span class="user-name" id="headerUsername"></span>
                <!-- 新增退出登录按钮 -->
                <button class="logout-btn" id="logoutBtn">退出</button>
            </div>
            <a href="#" class="logo">极简社交</a>
            <button class="publish-btn" id="mainPublishBtn">
                <i class="fas fa-plus"></i> 发布
            </button>
        </div>
    </header>
    <div class="main">
        <div class="content" id="contentContainer"></div>
        <div class="sidebar">
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i class="fas fa-compass"></i> 导航
                </div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-target="discover">
                            <i class="fas fa-compass nav-icon"></i>
                            <span>发现</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-target="attention">
                            <i class="fas fa-user-friends nav-icon"></i>
                            <span>关注</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-target="mypost">
                            <i class="fas fa-user nav-icon"></i>
                            <span>我的</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mobile-nav">
        <ul class="mobile-nav-list">
            <li>
                <a href="#" class="mobile-nav-link active" data-target="discover">
                    <i class="fas fa-compass mobile-nav-icon"></i>
                    <span>发现</span>
                </a>
            </li>
            <li>
                <a href="#" class="mobile-nav-link" data-target="attention">
                    <i class="fas fa-user-friends mobile-nav-icon"></i>
                    <span>关注</span>
                </a>
            </li>
            <li>
                <a href="#" class="mobile-nav-link" data-target="publish" id="mobilePublishLink">
                    <i class="fas fa-plus-circle mobile-nav-icon"></i>
                    <span>发布</span>
                </a>
            </li>
            <li>
                <a href="#" class="mobile-nav-link" data-target="mypost">
                    <i class="fas fa-user mobile-nav-icon"></i>
                    <span>我的</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="pagination" id="paginationContainer">
        <button class="page-prev" id="prevBtn">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="page-next" id="nextBtn">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <div class="publish-container" id="publishContainer">
        <div class="publish-header">
            <button class="back-btn" id="publishBackBtn">返回</button>
            <button class="send-btn" id="sendBtn">发送</button>
        </div>
        <textarea class="publish-input" placeholder="输入内容..." id="publishInput"></textarea>
    </div>
    <div class="profile-container" id="profileContainer">
        <div class="profile-header">
            <button class="back-btn" id="profileBackBtn">返回</button>
            <span class="logo">个人主页</span>
        </div>
        <div class="profile-content">
            <div class="profile-avatar-container">
                <img src="" alt="用户头像" class="profile-avatar" id="profileAvatar" data-username="">
            </div>
            <div class="profile-name" id="profileName"></div>
            <div class="profile-personality" id="profilePersonality">这个人很懒，什么都没留下</div>
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="followCount">0</div>
                    <div class="stat-label">关注</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fanCount">0</div>
                    <div class="stat-label">粉丝</div>
                </div>
            </div>
            <div class="profile-actions">
                <button class="edit-btn hidden" id="editBtn">编辑资料</button>
                <button class="follow-btn not-following" id="followBtn">关注</button>
            </div>
            <div class="profile-edit-inputs" id="profileEditInputs">
                <div class="edit-input-item">
                    <label class="edit-input-label" for="editName">用户名</label>
                    <input type="text" class="edit-input" id="editName" placeholder="输入用户名">
                </div>
                <div class="edit-input-item">
                    <label class="edit-input-label" for="editPersonality">个性签名</label>
                    <textarea class="edit-textarea" id="editPersonality" placeholder="输入个性签名"></textarea>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="save-btn" id="saveEditBtn">保存</button>
                    <button class="cancel-btn" id="cancelEditBtn">取消</button>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">
    <script>
        let currentPage = 1;
        const maxPageButtons = 5;
        let currentTab = 'discover';
        let userId = '';
        let username = '';
        let avatarUrl = '';
        let currentProfileUsername = '';
        const apiUrls = {
            discover: '/api/find',
            attention: '/api/attention',
            mypost: '/api/mypost',
            publish: '/api/publish',
            like: '/api/like',
            unlike: '/api/unlike',
            getcomment: '/api/getcomment',
            postcomment: '/api/postcomment',
            profile: '/api/profilepage',
            follow: '/api/follow',
            unfollow: '/api/unfollow',
            changemsg: '/api/changemsg',
            uploadavatar: '/api/uploadavatar'
        };
        const mainElements = document.querySelectorAll('.header, .main, .mobile-nav, .pagination');
        const publishContainer = document.getElementById('publishContainer');
        const publishInput = document.getElementById('publishInput');
        const contentContainer = document.getElementById('contentContainer');
        const headerAvatar = document.getElementById('headerAvatar');
        const headerUsername = document.getElementById('headerUsername');
        const profileContainer = document.getElementById('profileContainer');
        const avatarUploadInput = document.getElementById('avatarUploadInput');
        
        document.addEventListener('DOMContentLoaded', () => {
            getUserInfo();
            fetchPosts(currentPage);
            bindNavEvents();
            bindPublishEvents();
            bindProfileEvents();
            bindLogoutEvent(); // 绑定退出登录事件
        });
        
        function getUserInfo() {
            const storedUid = localStorage.getItem('uid');
            const storedName = localStorage.getItem('username');
            const storedAvatar = localStorage.getItem('avatar');
            if (storedUid) userId = storedUid;
            if (storedName) username = storedName;
            if (storedAvatar) avatarUrl = storedAvatar;
            headerAvatar.dataset.username = username;
            if (!storedUid) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlId = urlParams.get('id');
                if (urlId) {
                    userId = decodeURIComponent(urlId);
                    localStorage.setItem('uid', userId);
                }
            }
            updateHeaderUserInfo();
        }
        
        function updateHeaderUserInfo() {
            if (avatarUrl) headerAvatar.src = avatarUrl;
            if (username) headerUsername.textContent = username;
        }
        
        function bindNavEvents() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.dataset.target;
                    if (target) switchTab(target);
                });
            });
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.dataset.target;
                    if (target === 'publish') showPublishPage();
                    else if (target) switchTab(target);
                });
            });
        }
        
        function bindPublishEvents() {
            document.getElementById('mainPublishBtn').addEventListener('click', showPublishPage);
            document.getElementById('publishBackBtn').addEventListener('click', hidePublishPage);
            document.getElementById('sendBtn').addEventListener('click', sendPost);
        }
        
        function bindProfileEvents() {
            document.addEventListener('click', (e) => {
                const avatar = e.target.closest('.user-avatar, .post-avatar, .comment-avatar, .profile-avatar');
                if (avatar) {
                    const targetUsername = avatar.dataset.username;
                    if (targetUsername) {
                        if (targetUsername === username && profileContainer.style.display === 'block') {
                            avatarUploadInput.click();
                        } else if (targetUsername) {
                            showProfilePage(targetUsername);
                        }
                    }
                }
            });
            document.getElementById('profileBackBtn').addEventListener('click', hideProfilePage);
            document.getElementById('editBtn').addEventListener('click', showEditInputs);
            document.getElementById('cancelEditBtn').addEventListener('click', hideEditInputs);
            document.getElementById('saveEditBtn').addEventListener('click', saveProfileEdit);
            document.getElementById('followBtn').addEventListener('click', toggleFollow);
            avatarUploadInput.addEventListener('change', handleAvatarUpload);
        }
        
        // 新增：绑定退出登录事件
        function bindLogoutEvent() {
            document.getElementById('logoutBtn').addEventListener('click', function() {
                // 清除本地存储的用户信息
                localStorage.removeItem('uid');
                localStorage.removeItem('username');
                localStorage.removeItem('avatar');
                
                // 跳转到指定地址
                window.location.href = 'http://192.168.88.101:19200';
            });
        }
        
        function showProfilePage(targetUsername) {
            currentProfileUsername = targetUsername;
            mainElements.forEach(el => el.style.display = 'none');
            publishContainer.style.display = 'none';
            profileContainer.style.display = 'block';
            fetchProfileData(targetUsername);
        }
        
        function hideProfilePage() {
            profileContainer.style.display = 'none';
            mainElements.forEach(el => el.style.display = '');
            currentProfileUsername = '';
        }
        
        async function fetchProfileData(targetUsername) {
            const formData = `username=${encodeURIComponent(targetUsername)}&userid=${encodeURIComponent(userId)}`;
            const response = await fetch(`http://192.168.88.101:19200${apiUrls.profile}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: formData
            });
            const data = await response.json();
            
            const avatarUrlWithTimestamp = data.avatar ? `${data.avatar}?t=${Date.now()}` : 'https://picsum.photos/id/64/200';
            const profileAvatar = document.getElementById('profileAvatar');
            profileAvatar.src = avatarUrlWithTimestamp;
            profileAvatar.dataset.username = data.username;
            
            document.getElementById('profileName').textContent = data.username;
            document.getElementById('profilePersonality').textContent = data.personality;
            document.getElementById('followCount').textContent = data.followCount;
            document.getElementById('fanCount').textContent = data.fanCount;
            
            const isCurrentUser = currentProfileUsername === username;
            document.getElementById('editBtn').classList.toggle('hidden', !isCurrentUser);
            document.getElementById('followBtn').classList.toggle('hidden', isCurrentUser);
            
            const followBtn = document.getElementById('followBtn');
            if (data.isFollowed) {
                followBtn.classList.remove('not-following');
                followBtn.classList.add('following');
                followBtn.textContent = '已关注';
            } else {
                followBtn.classList.remove('following');
                followBtn.classList.add('not-following');
                followBtn.textContent = '关注';
            }
        }
        
        function showEditInputs() {
            const currentName = document.getElementById('profileName').textContent;
            const currentPersonality = document.getElementById('profilePersonality').textContent;
            document.getElementById('editName').value = currentName;
            document.getElementById('editPersonality').value = currentPersonality;
            document.getElementById('profileEditInputs').classList.add('active');
        }
        
        function hideEditInputs() {
            document.getElementById('profileEditInputs').classList.remove('active');
        }
        
        async function saveProfileEdit() {
            const newName = document.getElementById('editName').value.trim();
            const newPersonality = document.getElementById('editPersonality').value.trim();
            if (!newName || !userId) return;
            await fetch(`http://192.168.88.101:19200${apiUrls.changemsg}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `id=${userId}&name=${encodeURIComponent(newName)}&personality=${encodeURIComponent(newPersonality)}`
            });
            document.getElementById('profileName').textContent = newName;
            document.getElementById('profilePersonality').textContent = newPersonality;
            headerUsername.textContent = newName;
            localStorage.setItem('username', newName);
            username = newName;
            hideEditInputs();
        }
        
        function toggleFollow() {
            const followBtn = document.getElementById('followBtn');
            const fanCountEl = document.getElementById('fanCount');
            let fanCount = parseInt(fanCountEl.textContent) || 0;
            const targetUsername = currentProfileUsername;
            const myId = userId;
            if (followBtn.classList.contains('not-following')) {
                followBtn.classList.remove('not-following');
                followBtn.classList.add('following');
                followBtn.textContent = '已关注';
                fanCountEl.textContent = fanCount + 1;
                fetch(`http://192.168.88.101:19200${apiUrls.follow}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `myid=${myId}&upname=${encodeURIComponent(targetUsername)}`
                });
            } else {
                followBtn.classList.remove('following');
                followBtn.classList.add('not-following');
                followBtn.textContent = '关注';
                fanCountEl.textContent = Math.max(0, fanCount - 1);
                fetch(`http://192.168.88.101:19200${apiUrls.unfollow}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `myid=${myId}&upname=${encodeURIComponent(targetUsername)}`
                });
            }
        }
        
        async function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file || !userId) return;

            const pngBlob = await new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(blob => resolve(blob), 'image/png');
                };
                const reader = new FileReader();
                reader.onload = (e) => img.src = e.target.result;
                reader.readAsDataURL(file);
            });

            const uploadUrl = `http://192.168.88.101:19200${apiUrls.uploadavatar}?id=${encodeURIComponent(userId)}`;
            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: pngBlob,
                headers: {'Content-Type': 'image/png'}
            });

            const result = await response.json();
            if (result.status === 200) {
                const newAvatarUrl = `http://192.168.88.101:19200${result.data.headimg}?t=${Date.now()}`;
                document.getElementById('profileAvatar').src = newAvatarUrl;
                headerAvatar.src = newAvatarUrl;
                localStorage.setItem('avatar', newAvatarUrl);
                avatarUrl = newAvatarUrl;
                alert(result.message);
            } else {
                alert(`上传失败：${result.message}`);
            }
            avatarUploadInput.value = '';
        }
        
        function showPublishPage() {
            mainElements.forEach(el => el.style.display = 'none');
            publishContainer.style.display = 'block';
            publishInput.focus();
        }
        
        function hidePublishPage() {
            publishContainer.style.display = 'none';
            mainElements.forEach(el => el.style.display = '');
            publishInput.value = '';
        }
        
        async function sendPost() {
            const text = publishInput.value.trim();
            if (!text || !userId) return;
            const response = await fetch(`http://192.168.88.101:19200${apiUrls.publish}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `id=${userId}&text=${encodeURIComponent(text)}`
            });
            if (response.ok) {
                hidePublishPage();
                fetchPosts(currentPage);
            }
        }
        
        function switchTab(target) {
            currentTab = target;
            currentPage = 1;
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.target === target);
            });
            fetchPosts(currentPage);
        }
        
        async function fetchPosts(page) {
            contentContainer.innerHTML = '<div class="loading">加载中...</div>';
            const apiUrl = apiUrls[currentTab];
            let formData = `page=${page}`;
            if (userId) {
                formData += `&id=${userId}`;
            }
            const response = await fetch(`http://192.168.88.101:19200${apiUrl}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: formData
            });
            const result = await response.json();
            renderPosts(result.data);
            renderPagination(result.totalPages, page);
        }
        
        function renderPosts(posts) {
            contentContainer.innerHTML = '';
            if (posts.length === 0) {
                contentContainer.innerHTML = '<div style="text-align:center;padding:20px;">暂无数据</div>';
                return;
            }
            posts.forEach(post => {
                const avatarUrlWithTimestamp = post.avatar ? `${post.avatar}?t=${Date.now()}` : post.avatar;
                
                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                postCard.innerHTML = `
                    <div class="post-header">
                        <img src="${avatarUrlWithTimestamp}" alt="${post.author}的头像" class="post-avatar" data-username="${post.author}">
                        <div class="post-author">
                            <div class="author-name">${post.author}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    <div class="post-actions">
                        <div class="action-btn like-btn ${post.isLiked ? 'liked' : ''}" data-likes="${post.likes}" data-msgid="${post.msgid}">
                            <i class="${post.isLiked ? 'fas' : 'far'} fa-heart"></i>
                            <span>点赞(${post.likes})</span>
                        </div>
                        <div class="action-btn comment-btn" data-msgid="${post.msgid}" data-comments="${post.comments}">
                            <i class="far fa-comment"></i>
                            <span>评论(${post.comments})</span>
                        </div>
                    </div>
                    <div class="comments-container" id="comments-${post.msgid}">
                        <div class="comments-list" id="comments-list-${post.msgid}"></div>
                        <div class="comment-pagination" id="comment-pagination-${post.msgid}">
                            <button class="page-prev comment-prev" data-msgid="${post.msgid}">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="page-next comment-next" data-msgid="${post.msgid}">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="comment-input-container">
                            <input type="text" class="comment-input" placeholder="输入评论..." id="comment-input-${post.msgid}">
                            <button class="comment-send" data-msgid="${post.msgid}">发送</button>
                        </div>
                    </div>
                `;
                contentContainer.appendChild(postCard);
            });
            bindLikeEvents();
            bindCommentEvents();
        }
        
        function bindLikeEvents() {
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const icon = this.querySelector('i');
                    const text = this.querySelector('span');
                    let likes = parseInt(this.dataset.likes);
                    const msgid = this.dataset.msgid;
                    if (!userId || !msgid) return;
                    if (icon.classList.contains('far')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        this.classList.add('liked');
                        likes++;
                        fetch(`http://192.168.88.101:19200${apiUrls.like}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `userid=${userId}&msgid=${msgid}`
                        });
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        this.classList.remove('liked');
                        likes--;
                        fetch(`http://192.168.88.101:19200${apiUrls.unlike}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `userid=${userId}&msgid=${msgid}`
                        });
                    }
                    this.dataset.likes = likes;
                    text.textContent = `点赞(${likes})`;
                });
            });
        }
        
        function bindCommentEvents() {
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const msgid = this.dataset.msgid;
                    const targetContainer = document.getElementById(`comments-${msgid}`);
                    document.querySelectorAll('.comments-container.expanded').forEach(container => {
                        if (container.id !== `comments-${msgid}`) {
                            container.classList.remove('expanded');
                        }
                    });
                    targetContainer.classList.toggle('expanded');
                    if (targetContainer.classList.contains('expanded')) {
                        const commentPageKey = `commentPage-${msgid}`;
                        if (!window[commentPageKey]) window[commentPageKey] = 1;
                        fetchComments(msgid, window[commentPageKey]);
                    }
                });
            });
            document.querySelectorAll('.comment-prev').forEach(btn => {
                btn.addEventListener('click', function() {
                    const msgid = this.dataset.msgid;
                    const commentPageKey = `commentPage-${msgid}`;
                    if (!window[commentPageKey]) window[commentPageKey] = 1;
                    if (window[commentPageKey] > 1) {
                        window[commentPageKey]--;
                        fetchComments(msgid, window[commentPageKey]);
                    }
                });
            });
            document.querySelectorAll('.comment-next').forEach(btn => {
                btn.addEventListener('click', function() {
                    const msgid = this.dataset.msgid;
                    const commentPageKey = `commentPage-${msgid}`;
                    const totalPagesKey = `commentTotalPages-${msgid}`;
                    if (!window[commentPageKey]) window[commentPageKey] = 1;
                    if (!window[totalPagesKey]) window[totalPagesKey] = 1;
                    if (window[commentPageKey] < window[totalPagesKey]) {
                        window[commentPageKey]++;
                        fetchComments(msgid, window[commentPageKey]);
                    }
                });
            });
            document.querySelectorAll('.comment-send').forEach(btn => {
                btn.addEventListener('click', function() {
                    const msgid = this.dataset.msgid;
                    const input = document.getElementById(`comment-input-${msgid}`);
                    const text = input.value.trim();
                    if (!text || !userId) return;
                    const commentsList = document.getElementById(`comments-list-${msgid}`);
                    commentsList.innerHTML = '';
                    fetch(`http://192.168.88.101:19200${apiUrls.postcomment}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: `userid=${userId}&msgid=${msgid}&txt=${encodeURIComponent(text)}`
                    }).then(response => {
                        if (response.ok) {
                            input.value = '';
                            const commentBtn = document.querySelector(`.comment-btn[data-msgid="${msgid}"]`);
                            if (commentBtn) {
                                let currentComments = parseInt(commentBtn.dataset.comments);
                                currentComments++;
                                commentBtn.dataset.comments = currentComments;
                                commentBtn.querySelector('span').textContent = `评论(${currentComments})`;
                            }
                            const commentPageKey = `commentPage-${msgid}`;
                            fetchComments(msgid, window[commentPageKey] || 1);
                        }
                    });
                });
            });
        }
        
        async function fetchComments(msgid, page) {
            const commentsList = document.getElementById(`comments-list-${msgid}`);
            commentsList.innerHTML = '<div class="loading">加载评论中...</div>';
            const response = await fetch(`http://192.168.88.101:19200${apiUrls.getcomment}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `msgid=${msgid}&page=${page}`
            });
            const result = await response.json();
            renderComments(msgid, result.data);
            renderCommentPagination(msgid, result.totalPages, page);
            window[`commentTotalPages-${msgid}`] = result.totalPages;
        }
        
        function renderComments(msgid, comments) {
            const commentsList = document.getElementById(`comments-list-${msgid}`);
            commentsList.innerHTML = '';
            if (comments.length === 0) {
                commentsList.innerHTML = '<div style="text-align:center;padding:15px;font-size:14px;color:#666;">暂无评论</div>';
                return;
            }
            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                    <img src="${comment.avatar}" alt="${comment.author}的头像" class="comment-avatar" data-username="${comment.username || comment.author}">
                    <div class="comment-content">
                        <div class="comment-author">${comment.author}</div>
                        <div class="comment-text">${comment.content}</div>
                    </div>
                `;
                commentsList.appendChild(commentItem);
            });
        }
        
        function renderCommentPagination(msgid, totalPages, currentPage) {
            const paginationContainer = document.getElementById(`comment-pagination-${msgid}`);
            while (paginationContainer.children.length > 2) {
                paginationContainer.removeChild(paginationContainer.children[1]);
            }
            const prevBtn = paginationContainer.querySelector('.comment-prev');
            const nextBtn = paginationContainer.querySelector('.comment-next');
            for (let i = 1; i <= Math.min(totalPages, maxPageButtons); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    window[`commentPage-${msgid}`] = i;
                    fetchComments(msgid, i);
                });
                paginationContainer.insertBefore(pageBtn, nextBtn);
            }
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            nextBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
        }
        
        function renderPagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('paginationContainer');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            paginationContainer.querySelectorAll('.page-btn').forEach(btn => btn.remove());
            for (let i = 1; i <= Math.min(totalPages, maxPageButtons); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    fetchPosts(currentPage);
                });
                paginationContainer.insertBefore(pageBtn, nextBtn);
            }
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchPosts(currentPage);
                }
            };
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchPosts(currentPage);
                }
            };
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            nextBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
        }
    </script>
</body>
</html>